{"version":3,"file":"index.js","sources":["index.ts"],"sourceRoot":"/","sourcesContent":["import \"./application/services/sentry/instrument.js\";\nimport express from \"express\";\nimport dotenv from \"dotenv\";\nimport {\n  clientRoutes,\n  userRoutes,\n  visitRoutes,\n  stockItemRoutes,\n  stockAllowanceRoutes,\n  logRoutes,\n  procedureRoutes,\n  serviceRoutes,\n  teamMemberRoutes,\n  teamRoutes,\n} from \"./routes\";\nimport prisma from \"./infrastructure/data/prisma/prisma\";\nimport cors from \"cors\";\nimport { auth } from \"express-oauth2-jwt-bearer\";\nimport errorHandler from \"./utils/errorHandler\";\nimport ensureUserExistsMiddleware from \"./adapters/express/ensureUserExistsMiddleware\";\nimport ensureUserExistsUseCase from \"./application/use-cases/user/ensure-user-exists\";\nimport { getEnvVar } from \"./utils/getEnvVar\";\nimport subscriptionRouter from \"./routes/subscription-routes\";\nimport paymentRouter from \"./routes/payment-routes\";\nimport { makeExpressCallback } from \"./adapters/express/make-express-callback\";\nimport paymentController from \"./infrastructure/controllers/payment-controller\";\nimport Sentry from \"./application/services/sentry/sentry\";\nimport {\n  httpRequests,\n  metricsMiddleware,\n  register,\n} from \"./application/services/prometheus/prometheus\";\n\ndotenv.config();\n\nconst app = express();\nconst PORT = getEnvVar(\"PORT\") || 3000;\n\nconst jwtCheck = auth({\n  audience: getEnvVar(\"AUDIENCE\"),\n  issuerBaseURL: getEnvVar(\"AUTH0_ISSUER_BASE_URL\"),\n  tokenSigningAlg: getEnvVar(\"AUTH0_TOKE_SIGNING_ALG\"),\n});\n\napp.use(metricsMiddleware);\nregister.registerMetric(httpRequests);\n\napp.use(cors());\napp.use(express.json());\n\napp.use((req, res, next) => {\n  res.on(\"finish\", () => {\n    httpRequests.inc({ method: req.method, status: res.statusCode });\n  });\n  next();\n});\napp.get(\"/\", (req, res) => {\n  res.send(\"Aplikace kadeřník plus je v provozu.\");\n});\napp.options(\"/api/payment/callback\", cors());\napp.post(\n  \"/api/payment/callback\",\n  makeExpressCallback(paymentController.updatePushNotificationPaymentController)\n);\napp.use(jwtCheck);\napp.use(ensureUserExistsMiddleware(ensureUserExistsUseCase));\napp.use(\"/api/visits\", visitRoutes);\napp.use(\"/api/logs\", logRoutes);\napp.use(\"/api/team-members\", teamMemberRoutes);\napp.use(\"/api/team\", teamRoutes);\napp.use(\"/api/procedures\", procedureRoutes);\napp.use(\"/api/users\", userRoutes);\napp.use(\"/api/clients\", clientRoutes);\napp.use(\"/api/stock\", stockItemRoutes);\napp.use(\"/api/services\", serviceRoutes);\napp.use(\"/api/stock-allowance\", stockAllowanceRoutes);\napp.use(\"/api/subscription\", subscriptionRouter);\napp.use(\"/api/payment\", paymentRouter);\n\nSentry.setupExpressErrorHandler(app);\napp.use(errorHandler);\n\napp.get(\"/metrics\", async (req, res) => {\n  res.set(\"Content-Type\", register.contentType);\n  res.end(await register.metrics());\n});\n\nconst startServer = async () => {\n  try {\n    await prisma.$connect();\n    console.log(\"Connected to the database successfully!\");\n\n    app.listen(PORT, () => {\n      console.log(`Server is running on http://localhost:${PORT}`);\n    });\n  } catch (error) {\n    console.error(\"Failed to connect to the database or start server:\", error);\n    process.exit(1);\n  }\n};\n\nstartServer();\n\nprocess.on(\"beforeExit\", async () => {\n  await prisma.$disconnect();\n  console.log(\"Disconnected from the database.\");\n});\n"],"names":[],"mappings":"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","debug_id":"70711834-0fc0-5593-8974-a63cd1c94977"}